<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="description" content="description of your site">
    <meta name="author" content="author of the site">
    <!-- For mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>vim で powershell を書く！</title>
    <link rel="stylesheet" href="/css/master.css">
    <link media="only screen and (max-device-width: 480px)" rel="stylesheet" href="/css/mobile.css">
    <!--link(rel='stylesheet', href='/bower_components/google-code-prettify/src/prettify.css')-->
    <link rel="stylesheet" href="/bower_components/google-code-prettify/styles/desert.css">
  </head>
  <body>
    <header><a href="/">
        <h1>YUKIMEMI</h1></a>
      <div id="googlesearch"><script>
  (function() {
    var cx = '011218958289840355707:u8gwqtv7xgg';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//www.google.com/cse/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>

      </div>
    </header>
    <div id="posts">
      <h2>vim で powershell を書く！</h2>
      <p>[2014/02/08]</p><p>この記事は、 <a href="http://atnd.org/events/45072">Vim Advent Calendar 2013</a>
70日目の記事になります。</p>
<p><strong>vim</strong> で <strong>powershell</strong> を書く時の設定です。</p>
<p>まず、 <em>syntax</em> と <em>indent</em> 。
これは、以下のプラグインでOK。(なんかインデントは変だけど・・・)</p>
<pre><code class="lang-vim">NeoBundleLazy &#39;PProvost/vim-ps1&#39;</code></pre>
<p>それから、 <em>vim</em> から実行するために、 quickrun
を入れます。(これは定番ですね！)</p>
<pre><code class="lang-vim">NeoBundleLazy &#39;thinca/vim-quickrun&#39;</code></pre>
<p>ちょっと前までは、powershell
でquickrunするためには、設定が必要だったけど、最近オフィシャルに対応されるようになったみたいです。</p>
<p>参考: <a href="http://qiita.com/rbtnn/items/ea441a77181d29188880">VimとPowerShell -
Qiita</a></p>
<p>これで、powershellを書いてる時に、デフォルトだと <strong>\<Leader\>r</strong>
で実行できます。</p>
<p>さらに、おもむろに以下のファイルを作成して、 <em>header.cmd</em>
というファイル名で保存。</p>
<pre><code class="lang-bat">@echo off
pushd &quot;%~dp0&quot; &gt; nul
set tm=%time: =0%
set ps1file=%~n0___%date:~-10,4%%date:~-5,2%%date:~-2,2%_%tm:~0,2%%tm:~3,2%%tm:~6,2%%tm:~9,2%.ps1
for /f &quot;usebackq skip=10 delims=&quot; %%i in (&quot;%~f0&quot;) do @echo %%i &gt;&gt; &quot;%ps1file%&quot;
powershell -NoProfile -ExecutionPolicy unrestricted -File &quot;%ps1file%&quot; %*
del &quot;%ps1file%&quot;
popd &gt; nul
pause
exit /b %ERRORLEVEL%
# ========== do ps1 file as a dosbatch ==========</code></pre>
<p>そして、以下の設定を <em>.vimrc</em>
に書いておくと、powershellスクリプトを手軽に実行できるバッチファイルが作成できます。</p>
<pre><code class="lang-vim">let s:is_windows = has(&#39;win16&#39;) || has(&#39;win32&#39;) || has(&#39;win64&#39;)
let s:system = exists(&#39;g:loaded_vimproc&#39;) ? &#39;vimproc#system_bg&#39; : &#39;system&#39;

if neobundle#tap(&#39;vim-ps1&#39;)&quot;{{{
    call neobundle#config({
                \ &#39;autoload&#39;: {
                \   &#39;filetypes&#39;: &#39;ps1&#39;
                \ }
                \ })

    function! neobundle#tapped.hooks.on_source(bundle)
        function! s:make_ps12cmd()
            if s:is_windows
                let s:com = &quot;copy /b header.cmd + &quot; . expand(&quot;%:p:t&quot;) . &quot; &quot; . expand(&quot;%:p:t:r&quot;) . &quot;.cmd&quot;
            else
                let s:com = &quot;cat header.cmd &quot; . expand(&quot;%:p:t&quot;) . &quot; &gt; &quot; . expand(&quot;%:p:t:r&quot;) . &quot;.cmd&quot;
            endif
            echom(s:com)
            call {s:system}(s:com)
        endfunction
        au BufWritePost *.ps1 call s:make_ps12cmd()
    endfunction

    call neobundle#untap()
endif&quot;}}}</code></pre>
<p>やってることは単純で、さっきの <em>header.cmd</em> と作成中の powershell
スクリプトを合体させてるだけです。 windows の場合は、 <strong>copy</strong>
コマンドで。LinuxやMac の場合は、 <strong>cat</strong> コマンドで。</p>
<p>上記の設定では、保存時に自動で結合されて、元のpowershellファイルの拡張子が&quot;cmd&quot;になったものができあがります。</p>
<p>例えば、以下の <strong>hello.ps1</strong> をvim上で保存すると・・・</p>
<pre><code class="lang-ps1">Write-Host &quot;Hello ps1&quot;</code></pre>
<p>こんな <strong>hello.cmd</strong> ができてるはずです。</p>
<pre><code class="lang-bat">@echo off
pushd &quot;%~dp0&quot; &gt; nul
set tm=%time: =0%
set ps1file=%~n0___%date:~-10,4%%date:~-5,2%%date:~-2,2%_%tm:~0,2%%tm:~3,2%%tm:~6,2%%tm:~9,2%.ps1
for /f &quot;usebackq skip=10 delims=&quot; %%i in (&quot;%~f0&quot;) do @echo %%i &gt;&gt; &quot;%ps1file%&quot;
powershell -NoProfile -ExecutionPolicy unrestricted -File &quot;%ps1file%&quot; %*
del &quot;%ps1file%&quot;
popd &gt; nul
pause
exit /b %ERRORLEVEL%
# ========== do ps1 file as a dosbatch ==========

Write-Host &quot;Hello ps1&quot;</code></pre>
<p>このファイルは、エクスプローラからダブルクリックで実行出来ます。
一時ファイルを作成してから実行しているのでダサいし、途中でスクリプトを強制終了すると一時ファイルが残ったままになるという致命的な問題はありますが、まぁちょっとしたスクリプトにはいいんではないでしょうか。</p>
<p>ちなみに、 <em>neobundle</em> の tap と untap とかの設定は、 <em>supermomonga</em>
さんの
<a href="http://blog.supermomonga.com/articles/vim/neobundle-sugoi-setting.html">この記事</a>
がすごい参考になります。かなりすごいです。かなり。</p>
<p>さらにこの保存時に結合っていう方法を使えば、例えば先頭行にコメントで
import文みたいなのを入れておけば、動的に複数のpowershell
スクリプトを結合して、一つのバッチファイルにする・・・ってなこともできると思います。(誰かお願いします)</p>
<p>以上です。</p>

      <!-- addthis sharing button--><div id="addthis">
  <!-- Go to www.addthis.com/dashboard to customize your tools -->
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53d87e9e343919e9"></script>
  <!-- Go to www.addthis.com/dashboard to customize your tools -->
  <div class="addthis_native_toolbox"></div>
</div>

      <!-- twitter follow button--><div id="twitterfollow">
  <a href="https://twitter.com/yukimemi" class="twitter-follow-button" data-show-count="false">Follow @yukimemi</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

      <div id="back"><a href="/">&laquo; back to index</a></div>
      <hr>
      <!-- Disqus--><div id="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'yukimemi-github'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

    </div>
  </body>
  <script data-main="/js/main" src="/js/require.js"></script>
  <!-- google analytics--><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47356782-2', 'yukimemi.github.io');
  ga('send', 'pageview');
</script>

</html>